var AssetPack=function(a){this.total=this.loaded=0;this.bitmaps={};this.audio={};this.documents={};if(null!=a){for(var b in a.bitmaps)this.loadBitmap(b,a.bitmapPath+"/"+a.bitmaps[b]);for(var c in a.sounds)this.loadSound(c,a.soundPath+"/"+a.sounds[c]);for(var d in a.documents)this.loadXML(d,a.docPath+"/"+a.documents[d])}};AssetPack.prototype.loadBitmap=function(a,b){var c=this;++this.total;var d=new Image;d.onload=function(){++c.loaded};d.src=b;this.bitmaps[a]=d};
AssetPack.prototype.loadSound=function(a,b){var c=this;++this.total;this.audio[a]=new Howl({src:[b],onload:function(){++c.loaded}})};AssetPack.prototype.loadXML=function(a,b){var c=this;++this.total;var d=new XMLHttpRequest;d.overrideMimeType("text/xml");d.open("GET",b,!0);d.onreadystatechange=function(){4==d.readyState&&("200"==String(d.status)&&(c.documents[a]=d.responseText),++c.loaded)};d.send(null)};AssetPack.prototype.hasLoaded=function(){return 0==this.total||this.loaded>=this.total};
AssetPack.prototype.getPercentage=function(){return 0==this.total?0:this.loaded/this.total};var AudioPlayer=function(){this.enabled=!0;this.musicVol=this.sampleVol=1;this.musicSound=this.musicID=null;this.volCache=0};AudioPlayer.prototype.toggle=function(a){(this.enabled=a)?null!=this.musicSound&&null!=this.musicID&&this.musicSound.volume(this.volCache,this.musicID):null!=this.musicSound&&null!=this.musicID&&this.musicSound.volume(0,this.musicID)};
AudioPlayer.prototype.fadeInMusic=function(a,b,c){null==this.musicID&&(this.musicID=a.play(),this.musicSound=a);this.volCache=b*this.musicVol;a.volume(b*this.musicVol,a);a.loop(!0,this.musicID);this.enabled||(b=0);a.fade(0,b,c,this.musicID)};AudioPlayer.prototype.fadeOutMusic=function(a,b,c){null==this.musicID&&(this.musicID=a.play(),this.musicSound=a);a.volume(b*this.musicVol,a);a.loop(!0,this.musicID);this.enabled||(b=0);a.fade(b,0,c,this.musicID)};
AudioPlayer.prototype.stopMusic=function(){null!=this.musicSound&&null!=this.musicID&&(this.musicSound.stop(this.musicID),this.musicSound=this.musicID=null)};AudioPlayer.prototype.pauseMusic=function(){null!=this.musicSound&&null!=this.musicID&&this.musicSound.pause(this.musicID)};AudioPlayer.prototype.resumeMusic=function(){this.musicSound.play(this.musicID)};
AudioPlayer.prototype.playSample=function(a,b){this.enabled&&(b*=this.sampleVol,a.playID?(a.stop(a.playID),a.volume(b,a.playID),a.loop(!1,a.playID),a.play(a.playID)):(a.playID=a.play(),a.volume(b,a.playID),a.loop(!1,a.playID)))};var Core=function(){this.scenes=[];this.globalScene=this.activeScene=null;this.framerate=30;this.oldTime=-1;this.timeSum=0;this.onLoadCalled=!1};
Core.prototype.init=function(a,b){var c=this;this.assets=new AssetPack(a);this.graphics=new GraphicsCore(this.assets.bitmaps);this.input=new InputManager(this.graphics);this.audio=new AudioPlayer;this.vpad=new Vpad(this.input,b);this.tr=new Transition;this.evMan=new EventManager(this,this.audio,this.assets.audio,this.vpad,this.tr);window.addEventListener("resize",function(){c.graphics.resize(window.innerWidth,window.innerHeight)});for(b=0;b<this.scenes.length;++b)a=this.scenes[b],null!=a.init&&a.init(this.evMan)};
Core.prototype.update=function(a){a/=1/60;null!=this.activeScene&&null!=this.activeScene.update&&this.activeScene.update(this.evMan,a);null!=this.globalScene&&null!=this.globalScene.update&&this.globalScene.update(this.evMan,a);this.vpad.update();this.input.update();this.tr.update(a)};
Core.prototype.drawLoadingScreen=function(){var a=this.graphics.canvas.width/4,b=a/8;this.graphics.clear(0,0,0);var c=this.assets.getPercentage(),d=this.graphics.canvas.width/2-a/2,e=this.graphics.canvas.height/2-b/2;this.graphics.fillRect(d-2,e-2,a+4,b+4,{r:255,g:255,b:255});this.graphics.fillRect(d-1,e-1,a+2,b+2,{r:0,g:0,b:0});this.graphics.fillRect(d,e,a*c|0,b,{r:255,g:255,b:255})};
Core.prototype.draw=function(){null!=this.activeScene&&null!=this.activeScene.draw&&this.activeScene.draw(this.graphics);null!=this.globalScene&&null!=this.globalScene.draw&&this.globalScene.draw(this.graphics);this.tr.draw(this.graphics)};Core.prototype.onLoad=function(){for(var a,b=0;b<this.scenes.length;++b)if(a=this.scenes[b],null!=a.onLoad)a.onLoad(this.assets)};
Core.prototype.loop=function(a){var b=this;0>this.oldTime&&(this.oldTime=a);var c=1/this.framerate,d=a-this.oldTime;this.assets.hasLoaded()&&(this.timeSum+=d/1E3,this.onLoadCalled||(this.onLoad(),this.onLoadCalled=!0));d=0;for(var e=!1;this.assets.hasLoaded()&&this.timeSum>=c;)if(e=!0,this.update(c),this.timeSum-=c,5<=++d){this.timeSum=0;break}this.assets.hasLoaded()?e&&this.draw():this.drawLoadingScreen();this.oldTime=a;window.requestAnimationFrame(function(a){return b.loop(a)})};
Core.prototype.run=function(a,b,c){var d=this;this.framerate=null==a?30:a;this.init(b,c);window.requestAnimationFrame(function(a){return d.loop(a)})};Core.prototype.changeScene=function(a,b){for(var c=0;c<this.scenes.length;++c)if(this.scenes[c].name==a&&(this.activeScene=this.scenes[c],null!=this.activeScene.onChange)){this.activeScene.onChange(b);break}};Core.prototype.addScene=function(a,b,c){this.scenes.push(a);b&&(this.activeScene=a);c&&(this.globalScene=a)};var EventManager=function(a,b,c,d,e){this.core=a;this.audio=b;this.sounds=c;this.vpad=d;this.transition=e;this.input=d.input};EventManager.prototype.changeScene=function(a,b){this.core.changeScene(a,b)};var Vpad=function(a,b){this.input=a;this.stick=new Vec2;this.oldStick=this.stick.copy();this.stickDelta=new Vec2;this.buttons={};if(null!=b)for(var c in b.buttons)this.buttons[c]={key:b.buttons[c],state:State.Up}};
Vpad.prototype.update=function(){this.oldStick.x=this.stick.x;this.oldStick.y=this.stick.y;this.stick.x=0;this.stick.y=0;this.input.getKey(37)==State.Down?this.stick.x=-1:this.input.getKey(39)==State.Down&&(this.stick.x=1);this.input.getKey(38)==State.Down?this.stick.y=-1:this.input.getKey(40)==State.Down&&(this.stick.y=1);this.stickDelta.x=this.stick.x-this.oldStick.x;this.stickDelta.y=this.stick.y-this.oldStick.y;for(k in this.buttons)this.buttons[k].state=this.input.getKey(this.buttons[k].key)};var Flip={None:0,Horizontal:1,Vertical:2,Both:3},GraphicsCore=function(a){this.canvas=document.getElementById("canvas");this.ctx=this.canvas.getContext("2d");this.ctx.imageSmoothingEnabled=!1;this.cpos=new Vec2;this.csize=new Vec2;this.resize(window.innerWidth,window.innerHeight);this.bitmaps=a;this.tr=new Vec2(0,0)};GraphicsCore.prototype.getColorString=function(a,b,c,d){null==d&&(d=1);return"rgba("+String(a|0)+","+String(b|0)+","+String(c|0)+","+String(d)+")"};
GraphicsCore.prototype.resize=function(a,b){var c=this.canvas,d=Math.min(a/c.width|0,b/c.height|0);var e=c.width*d;d*=c.height;a=a/2-e/2;b=b/2-d/2;this.cpos.x=a;this.cpos.y=b;this.csize.x=e;this.csize.y=d;b=String(b|0)+"px";a=String(a|0)+"px";c.style.height=String(d|0)+"px";c.style.width=String(e|0)+"px";c.style.top=b;c.style.left=a};GraphicsCore.prototype.setGlobalAlpha=function(a){null==a&&(a=1);this.ctx.globalAlpha=a};
GraphicsCore.prototype.clear=function(a,b,c){var d=this.ctx;d.fillStyle=this.getColorString(a,b,c);d.fillRect(0,0,this.canvas.width,this.canvas.height)};GraphicsCore.prototype.drawBitmap=function(a,b,c,d){this.drawBitmapRegion(a,0,0,a.width,a.height,b,c,d)};GraphicsCore.prototype.drawScaledBitmap=function(a,b,c,d,e,f){this.drawScaledBitmapRegion(a,0,0,a.width,a.height,b,c,d,e,f)};GraphicsCore.prototype.drawBitmapRegion=function(a,b,c,d,e,f,h,g){this.drawScaledBitmapRegion(a,b,c,d,e,f,h,d,e,g)};
GraphicsCore.prototype.drawScaledBitmapRegion=function(a,b,c,d,e,f,h,g,n,m){if(!(0>=g||0>=n||0>=d||0>=e)){f+=this.tr.x;h+=this.tr.y;b|=0;c|=0;d|=0;e|=0;f|=0;h|=0;g|=0;n|=0;m|=Flip.None;var l=this.ctx;m!=Flip.None&&l.save();0!=(m&Flip.Horizontal)&&(l.translate(g,0),l.scale(-1,1),f*=-1);0!=(m&Flip.Vertical)&&(l.translate(0,n),l.scale(1,-1),h*=-1);l.drawImage(a,b,c,d,e,f,h,g,n);m!=Flip.None&&l.restore()}};
GraphicsCore.prototype.drawText=function(a,b,c,d,e,f,h){var g=a.width/16,n=b.length,m=c;h&&(m=c-=n/2*(g+e));for(var l=0;l<n;++l){var p=b.charCodeAt(l);"\n"==b[l]?(m=c,d+=f+g):(h=p%16,p=p/16|0,this.drawBitmapRegion(a,h*g,p*g,g,g,m,d,Flip.NONE),m+=g+e)}};GraphicsCore.prototype.fillRect=function(a,b,c,d,e){var f=this.ctx;null!=e&&(f.fillStyle=this.getColorString(e.r,e.g,e.b,e.a));a+=this.tr.x;b+=this.tr.y;f.fillRect(a|0,b|0,c|0,d|0)};
GraphicsCore.prototype.setTranslation=function(a,b){this.tr.x=a;this.tr.y=b};GraphicsCore.prototype.translate=function(a,b){this.tr.x+=a;this.tr.y+=b};var State={Up:0,Down:1,Pressed:2,Released:3},InputManager=function(a){var b=this;window.addEventListener("keydown",function(a){a.preventDefault();b.keyPressed(a.keyCode)});window.addEventListener("keyup",function(a){a.preventDefault();b.keyReleased(a.keyCode)});window.addEventListener("mousedown",function(a){window.focus();a.preventDefault();b.mouseButtonPressed(a.button)});window.addEventListener("mouseup",function(a){a.preventDefault();b.mouseButtonReleased(a.button)});window.addEventListener("mousemove",
function(a){window.focus();b.mouseMove(a.clientX,a.clientY)});this.keyStates=Array(256);for(var c=0;c<this.keyStates.length;++c)this.keyStates[c]=State.Up;this.mouseStates=Array(3);for(c=0;c<this.mouseStates.length;++c)this.mouseStates[c]=State.Up;this.mousePos=new Vec2;this.anyKeyPressed=!1;this.g=a};InputManager.prototype.eventPressed=function(a,b,c){0>b||b>=a.length||a[b]==State.Down||(a[b]=State.Pressed,null!=c&&c(b))};
InputManager.prototype.eventReleased=function(a,b){0>b||b>=a.length||a[b]==State.Up||(a[b]=State.Released)};InputManager.prototype.updateStateArray=function(a){for(var b=0;b<a.length;++b)a[b]==State.Pressed?a[b]=State.Down:a[b]==State.Released&&(a[b]=State.Up)};InputManager.prototype.keyPressed=function(a){var b=this;this.eventPressed(this.keyStates,a,function(){b.anyKeyPressed=!0})};InputManager.prototype.keyReleased=function(a){this.eventReleased(this.keyStates,a)};
InputManager.prototype.mouseButtonPressed=function(a){this.eventPressed(this.mouseStates,a)};InputManager.prototype.mouseButtonReleased=function(a){this.eventReleased(this.mouseStates,a)};InputManager.prototype.mouseMove=function(a,b){a-=this.g.cpos.x;b-=this.g.cpos.y;this.mousePos.x=a/this.g.csize.x*this.g.canvas.width;this.mousePos.y=b/this.g.csize.y*this.g.canvas.height};InputManager.prototype.update=function(){this.anyKeyPressed=!1;this.updateStateArray(this.keyStates);this.updateStateArray(this.mouseStates)};
InputManager.prototype.getKey=function(a){return 0>a||a>=this.keyStates.length?State.Up:this.keyStates[a]};InputManager.prototype.getMouseButton=function(a){return 0>a||a>=this.mouseStates.length?State.Up:this.mouseStates[a]};var AnimatedSprite=function(a,b){this.width=a;this.height=b;this.count=this.row=this.frame=0};AnimatedSprite.prototype.animate=function(a,b,c,d,e){b==c?(this.count=0,this.frame=b,this.row=a):(this.row!=a&&(this.count=0,this.frame=c>b?b:c,this.row=a),b<c&&this.frame<b?this.frame=b:c<b&&this.frame<c&&(this.frame=c),this.count+=1*e,this.count>d&&(b<c?++this.frame>c&&(this.frame=b):--this.frame<c&&(this.frame=b),this.count-=d))};
AnimatedSprite.prototype.drawFrame=function(a,b,c,d,e,f,h){a.drawBitmapRegion(b,this.width*c,this.height*d,this.width,this.height,e,f,h)};AnimatedSprite.prototype.draw=function(a,b,c,d,e){this.drawFrame(a,b,this.frame,this.row,c,d,e)};var negMod=function(a,b){return 0>a?b- -a%b:a%b},Tilemap=function(a){a=(new DOMParser).parseFromString(a,"text/xml").getElementsByTagName("map")[0];this.width=String(a.getAttribute("width"));this.height=String(a.getAttribute("height"));a=a.getElementsByTagName("layer");this.layers=[];for(var b=0;b<a.length;++b){var c=a[b].getElementsByTagName("data")[0].childNodes[0].nodeValue.replace(/(\r\n|\n|\r)/gm,"").split(",");this.layers.push([]);for(var d=0;d<c.length;++d)this.layers[b][d]=parseInt(c[d])}};
Tilemap.prototype.getTile=function(a,b,c,d){b|=0;c|=0;d&&(b=negMod(b,this.width),c=negMod(c,this.height));return 0>b||0>c||b>=this.width||c>=this.height?-1:this.layers[a][c*this.width+b]};Tilemap.prototype.setTile=function(a,b,c,d){c|=0;d|=0;0>c||0>d||c>=this.width||d>=this.height||(this.layers[b][d*this.width+c]=a)};var INITIAL_TRANSITION_TIME=60,Fade={In:0,Out:1},Transition=function(){this.timer=0;this.speed=1;this.color={r:0,g:0,b:0};this.active=!1;this.division=-1;this.cb=null};Transition.prototype.activate=function(a,b,c,d,e){this.mode=a;this.speed=b;this.cb=c;this.active=!0;this.timer=INITIAL_TRANSITION_TIME;this.division=null==e?-1:e;null!=d?this.color=d:(this.color.r=0,this.color.g=0,this.color.b=0)};
Transition.prototype.update=function(a){this.active&&(this.timer-=this.speed*a,0>=this.timer&&(this.mode==Fade.In?(null!=this.cb&&this.cb(),this.mode=Fade.Out,this.timer+=INITIAL_TRANSITION_TIME):this.active=!1))};Transition.prototype.draw=function(a){if(this.active){var b=a.canvas.width,c=a.canvas.height,d=this.timer/INITIAL_TRANSITION_TIME;this.mode==Fade.In&&(d=1-d);0<this.division&&(d=(d*this.division|0)/this.division);this.color.a=d;a.fillRect(0,0,b,c,this.color)}};var Vec2=function(a,b){this.x=null!=a?a:0;this.y=null!=b?b:0};Vec2.prototype.addVec2=function(a){return new Vec2(this.x+a.x,this.y+a.y)};Vec2.prototype.add=function(a,b){return new Vec2(this.x+a,this.y+b)};Vec2.prototype.copy=function(){return new Vec2(this.x,this.y)};
